name: commercial_solvers
description: Set up commercial solvers in CI for testing purposes
inputs:
  token:
    description: GitHub token with access to the private repo
    required: true

runs:
  using: "composite"
  steps:
    - run: echo "$RUNNER_OS-$RUNNER_ARCH"
      shell: bash
    - uses: kanga333/variable-mapper@v0.3.0
      with:
        key: "$RUNNER_OS-$RUNNER_ARCH"
        map: |
         {
            "Linux-X64": {"knitro": "knitro-13.2.0-Linux-64"},
            "Windows-X64": {"knitro": "knitro-13.2.0-Win64"},
            "macOS-X64": {"knitro": "knitro-13.2.0-MacOS-64"},
            "macOS-ARM64": {"knitro": "knitro-13.2.0-MacOS-ARM"}
         }
        export_to: env
    # Download protected release asset
    - uses: dsaltares/fetch-gh-release-asset@1.1.0
      with:
        repo: 'jgillis/restricted'
        file: ${{env.knitro}}.tar.gz
        token: ${{ inputs.token }}
    - uses: dsaltares/fetch-gh-release-asset@1.1.0
      with:
        repo: 'jgillis/restricted'
        file: 'artelys_lic_5007_casadi-dev_2022-08-24.txt'
        token: ${{ inputs.token }}
    - run: tar -xzf ${{env.knitro}}.tar.gz -C $RUNNER_TEMP
      shell: bash
      if: "$RUNNER_OS != 'Windows'"
    - run: unzip ${{env.knitro}}.zip -d $RUNNER_TEMP
      shell: bash
      if: "$RUNNER_OS == 'Windows'"
    - run: cp artelys_lic_5007_casadi-dev_2022-08-24.txt $RUNNER_TEMP
      shell: bash
      
    # Add to PATH
    - run: echo "LD_LIBRARY_PATH=$RUNNER_TEMP/${{env.knitro}}/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV
      if: "$RUNNER_OS != 'Windows'"
      shell: bash
    - run: echo "$PATH"
      shell: bash
    - run: echo "PATH=$RUNNER_TEMP/${{env.knitro}}/lib;$PATH" >> $GITHUB_ENV
      if: "$RUNNER_OS == 'Windows'"
      shell: bash
    - run: echo "LD_PRELOAD=$RUNNER_TEMP/${{env.knitro}}/lib/libiomp5.so" >> $GITHUB_ENV
      if: "$RUNNER_OS != 'Windows'"
      shell: bash
    - run: echo "ARTELYS_LICENSE=$RUNNER_TEMP/artelys_lic_5007_casadi-dev_2022-08-24.txt" >> $GITHUB_ENV
      shell: bash
      
